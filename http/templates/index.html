<!DOCTYPE html>
<html>
<head>
	<title>A/V remote control</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/static/FortAwesome-Font-Awesome-ee55c85/css/font-awesome.css" />
	<link rel="stylesheet" href="/static/jquery.mobile-1.1.0.min.css" />
	<script src="/static/jquery-1.7.2.min.js"></script>
	<script src="/static/jquery.mobile-1.1.0.min.js"></script>
	<script>

var event_source = null;
var watchdog = null;
var connected = null;

function send_cmd(cmd) {
	var url = "/" + cmd.replace(/ /g, "/");
	$.ajax({
		url: encodeURIComponent(url),
		type: 'POST'
	});
}

function repeat_cmd(cmd, repeats) {
	var i = 0
	while (i < repeats) {
		send_cmd(cmd);
		i++;
	}
}

function ui_enable(selector, enable) {
	if (enable) {
		$(selector).removeClass('ui-disabled');
	}
	else {
		$(selector).addClass('ui-disabled');
	}
}

function parse_avr_state(e) {
	var s = JSON.parse(e.data); // extract AVR state info

	if (!s) {
		return $('#avr_state').html("<p>Unknown</p>");
	}

	ui_enable('#avr_controls', !s.off);
	if (s.off) {
		return $('#avr_state').html("<p>Off</p>");
	}

	ui_enable('#avr_surroundcontrols', !s.standby);
	ui_enable('#avr_volumecontrols', !s.standby);
	$('#avr_button_on').toggle(s.standby);
	$('#avr_button_off').toggle(!s.standby);
	if (s.standby) {
		return $('#avr_state').html("<p>Standby</p>");
	}

	var state_str = "<fieldset class=\"ui-grid-a\" style=\"margin: 10px 0;\">\n"
	state_str += "<pre class=\"ui-block-a\">";
	state_str += $.trim(s.line1) + "\n";
	state_str += $.trim(s.line2) + "\n";
	state_str += "</pre>\n<pre class=\"ui-block-b\">";
	state_str += s.source + "/" + s.channels_string;
	state_str += " -> " + s.speakers_str + "\n";
	state_str += s.surround_string + "\n";
	state_str += "</pre>\n</fieldset>";
	$('#avr_state').html(state_str);

	if (s.volume != null) {
		var vol = s.volume + "dB\n";
		$('#avr_volume').text(vol);
	}
	if (s.mute) {
		$('#avr_volume').text("Muted");
	}
}

function set_connected(is_connected) {
	if (is_connected == connected) {
		return; // No change
	}
	// Show a dialog while (re)connecting, and hide it when done
	if (!is_connected) {
		var txt = 'Reconnecting to event server';
		if (connected == null) {
			// First time connecting
			txt = 'Connecting to event server';
		}
		ui_enable('#controls_page', false);
		$.mobile.showPageLoadingMsg('a', txt, true);
	}
	else {
		ui_enable('#controls_page', true);
		$.mobile.hidePageLoadingMsg();
	}
	connected = is_connected;
}

function lost_connection() {
	set_connected(false);
	event_source.close();
	connect_event_source();
}

function maybe_lost_connection() {
	if (event_source.readyState == 2) { // event_source is CLOSED
		lost_connection();
	}
	// Else hope that event_source manages to re-sync itself
}

function reset_watchdog() {
	if (watchdog) {
		clearTimeout(watchdog);
	}
	watchdog = setTimeout(lost_connection, 5000);
	set_connected(true);
}

function connect_event_source() {
	set_connected(false);
	event_source = new EventSource('/events');
	event_source.addEventListener('open', reset_watchdog, false);
	event_source.addEventListener('error', maybe_lost_connection, false);
	event_source.addEventListener('heartbeat', reset_watchdog, false);
	event_source.addEventListener('avr_update', parse_avr_state, false);
}

window.onload = connect_event_source;

	</script>
</head>
<body>

<div data-role="page" id="controls_page" class="ui-disabled" style="text-align: center">

<div data-role="header">
	<h1>A/V remote control</h1>
</div>

{% if "avr on" in cmd_handlers %}
<div data-role="content" id="avr_controls" class="ui-disabled">
	<h2>Surround Receiver</h2>

	<span id="avr_button_on">
		<a onclick="send_cmd('avr on')" data-inline="true" data-theme="a" data-role="button">
			<i class="icon-off"></i>
		</a>
	</span>
	<span id="avr_button_off">
		<a onclick="send_cmd('avr off')" data-inline="true" data-theme="a" data-role="button">
			<i class="icon-off"></i>
		</a>
	</span>
	<span id="avr_surroundcontrols" data-role="controlgroup" data-type="horizontal">
		<!-- <a onclick="send_cmd('avr surround 6ch')" data-role="button">
			5.1
		</a> -->
		<a onclick="send_cmd('avr surround dolby')" data-role="button">
			<!-- Dolby -->Surround
		</a>
		<!-- <a onclick="send_cmd('avr surround dts')" data-role="button">
			DTS
		</a> -->
		<a onclick="send_cmd('avr surround stereo')" data-role="button">
			Stereo
		</a>
	</span>

	<div id="avr_volumecontrols" data-role="controlgroup" data-type="horizontal">
		<a onclick="repeat_cmd('avr vol-', 5)" data-role="button">
			5<i class="icon-volume-down"></i>
		</a>
		<a onclick="send_cmd('avr vol-')" data-role="button">
			<i class="icon-volume-down"></i>
		</a>
		<a onclick="send_cmd('avr mute')" data-theme="b" data-role="button">
			<i class="icon-volume-off"></i>
			<span id="avr_volume">Unknown</span>
			<i class="icon-volume-off"></i>
		</a>
		<a onclick="send_cmd('avr vol+')" data-role="button">
			<i class="icon-volume-up"></i>
		</a>
		<a onclick="repeat_cmd('avr vol+', 5)" data-role="button">
			5<i class="icon-volume-up"></i>
		</a>
	</div>

	<div id="avr_state"><p>Initializing...</p></div>
</div>
{% end %}

{% if "hdmi on" in cmd_handlers %}
<div data-role="content" id="hdmi_controls" class="ui-disabled">
	<h2>HDMI Switch</h2>

	<a onclick="send_cmd('hdmi on')" data-inline="true" data-theme="a" data-role="button">
		<i class="icon-off"></i>
	</a>
	<span data-role="controlgroup" data-type="horizontal">
		<a onclick="send_cmd('hdmi 1')" data-role="button">HTPC</a>
		<a onclick="send_cmd('hdmi 2')" data-role="button">Get</a>
		<a onclick="send_cmd('hdmi 3')" data-role="button">PS3</a>
		<a onclick="send_cmd('hdmi 4')" data-role="button">Wii</a>
	</span>

	<pre id="hdmi_state">???</pre>
</div>
{% end %}

<div data-role="footer">
	<p>by Johan Herland
	&lt;<a href="mailto:johan@herland.net">johan@herland.net</a>&gt;</p>
</div>

</div>

</body>
</html>
