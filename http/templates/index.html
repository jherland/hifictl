<!DOCTYPE html>
<html>
<head>
	<title>{{ title }}</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/static/jquery.mobile-1.1.0.min.css" />
	<script src="/static/jquery-1.7.2.min.js"></script>
	<script src="/static/jquery.mobile-1.1.0.min.js"></script>
	<script>

function send_cmd(cmd) {
	var url = "/" + cmd.replace(/ /g, "/");
	$.ajax({
		url: encodeURIComponent(url),
		type: 'POST'
	});
}

function ui_disable(selector, disable) {
	if (disable) {
		$(selector).addClass('ui-disabled');
	}
	else {
		$(selector).removeClass('ui-disabled');
	}
}

function parse_avr_state(e) {
	var s = JSON.parse(e.data); // extract AVR state info

	if (!s) {
		return $('#avr_state').text("Unknown");
	}

	ui_disable('#avr_controls', s.off);
	if (s.off) {
		return $('#avr_state').text("Off");
	}

	ui_disable('#avr_subcontrols', s.standby);
	$('#avr_button_on').toggle(s.standby);
	$('#avr_button_off').toggle(!s.standby);
	if (s.standby) {
		return $('#avr_state').text("Standby");
	}

	var state_str = $.trim(s.line1) + "\n";
	state_str += $.trim(s.line2) + "\n";
	if (s.volume != null) {
		var vol = s.volume + "dB\n";
		state_str += vol;
		$('#avr_volume .ui-btn-text').text(vol);
	}
	if (s.mute) {
		$('#avr_volume .ui-btn-text').text("Muted")
	}
	state_str += s.source + "/" + s.channels_string + "\n";
	state_str += s.surround_string + "\n";
	state_str += s.speakers_string;
	$('#avr_state').text(state_str);
}

var source = new EventSource('/events');
source.onmessage = parse_avr_state;

	</script>
</head>
<body>

<div data-role="page" id="main" style="text-align: center">

<div data-role="header">
	<h1>A/V Control</h1>
</div><!-- /header -->

<div data-role="content">
	{% if "avr on" in cmd_handlers %}
	<div id="avr_controls">
		<h3>Surround Receiver</h3>
		<span id="avr_button_on">
			<button onclick="send_cmd('avr on')"
				data-inline="true"
				data-theme="a">On</button>
		</span>
		<span id="avr_button_off">
			<button onclick="send_cmd('avr off')"
				data-inline="true"
				data-theme="a">Off</button>
		</span>
		<div id="avr_subcontrols">
			<div data-role="controlgroup" data-type="horizontal">
				<button onclick="send_cmd('avr vol-')"><b>-</b></button>
				<span id="avr_volume">
					<button onclick="send_cmd('avr mute')" data-theme="b">?</button>
				</span>
				<button onclick="send_cmd('avr vol+')"><b>+</b></button>
			</div>
			<div data-role="controlgroup" data-type="horizontal">
				<!-- <button onclick="send_cmd('avr surround 6ch')">5.1</button> -->
				<button onclick="send_cmd('avr surround dolby')">Surround<!-- Dolby --></button>
				<!-- <button onclick="send_cmd('avr surround dts')">DTS</button> -->
				<button onclick="send_cmd('avr surround stereo')">Stereo</button>
			</div>
		</div>
	</div>
	{% end %}

	{% if "hdmi on" in cmd_handlers %}
	<div id="hdmi_controls">
		<h3>HDMI Switch</h3>
		<div data-role="controlgroup" data-type="horizontal">
			<button onclick="send_cmd('hdmi on')" data-theme="a">On/Off</button>
			<button onclick="send_cmd('hdmi 1')">HTPC</button>
			<button onclick="send_cmd('hdmi 2')">Get</button>
			<button onclick="send_cmd('hdmi 3')">PS3</button>
			<!-- <button onclick="send_cmd('hdmi 4')">Wii</button> -->
		</div>
	</div>
	{% end %}
</div><!-- /content -->

<div data-role="footer">
	<pre id="avr_state">Initializing...</pre>
</div><!-- /footer -->

</div><!-- /page -->

</body>
</html>
