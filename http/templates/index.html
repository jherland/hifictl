<!DOCTYPE html>
<html>
<head>
	<title>A/V remote control</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/static/jquery.mobile-1.1.0.min.css" />
	<script src="/static/jquery-1.7.2.min.js"></script>
	<script src="/static/jquery.mobile-1.1.0.min.js"></script>
	<script>

var event_source = null;
var watchdog = null;
var connecting = false;

function send_cmd(cmd) {
	var url = "/" + cmd.replace(/ /g, "/");
	$.ajax({
		url: encodeURIComponent(url),
		type: 'POST'
	});
}

function repeat_cmd(cmd, repeats) {
	var i = 0
	while (i < repeats) {
		send_cmd(cmd);
		i++;
	}
}

function ui_enable(selector, enable) {
	if (enable) {
		$(selector).removeClass('ui-disabled');
	}
	else {
		$(selector).addClass('ui-disabled');
	}
}

function parse_avr_state(e) {
	var s = JSON.parse(e.data); // extract AVR state info

	if (!s) {
		return $('#avr_state').html("<p>Unknown</p>");
	}

	ui_enable('#avr_controls', !s.off);
	if (s.off) {
		return $('#avr_state').html("<p>Off</p>");
	}

	ui_enable('#avr_surroundcontrols', !s.standby);
	ui_enable('#avr_volumecontrols', !s.standby);
	$('#avr_button_on').toggle(s.standby);
	$('#avr_button_off').toggle(!s.standby);
	if (s.standby) {
		return $('#avr_state').html("<p>Standby</p>");
	}

	var state_str = "<fieldset class=\"ui-grid-a\" style=\"margin: 10px 0;\">\n"
	state_str += "<pre class=\"ui-block-a\">";
	state_str += $.trim(s.line1) + "\n";
	state_str += $.trim(s.line2) + "\n";
	state_str += "</pre>\n<pre class=\"ui-block-b\">";
	state_str += s.source + "/" + s.channels_string;
	state_str += " -> " + s.speakers_str + "\n";
	state_str += s.surround_string + "\n";
	state_str += "</pre>\n</fieldset>";
	$('#avr_state').html(state_str);

	if (s.volume != null) {
		var vol = s.volume + "dB\n";
		$('#avr_volume .ui-btn-text').text(vol + "| Mute");
	}
	if (s.mute) {
		$('#avr_volume .ui-btn-text').text("Unmute");
	}
}

function set_connecting(is_connecting) {
	if (is_connecting == connecting) {
		return; // No change
	}
	// Show a dialog while connecting, and hide it when done
	if (is_connecting) {
		$.mobile.showPageLoadingMsg(
			'a', 'Reconnecting to event server', true);
	}
	else {
		$.mobile.hidePageLoadingMsg();
	}
	connecting = is_connecting;
}

function lost_connection() {
	set_connecting(true);
	event_source.close();
	connect_event_source();
}

function maybe_lost_connection() {
	if (event_source.readyState == 2) { // event_source is CLOSED
		lost_connection();
	}
	// Else hope that event_source manages to re-sync itself
}

function reset_watchdog() {
	if (watchdog) {
		clearTimeout(watchdog);
	}
	watchdog = setTimeout(lost_connection, 5000);
	set_connecting(false);
}

function connect_event_source() {
	event_source = new EventSource('/events');
	event_source.addEventListener('open', reset_watchdog, false);
	event_source.addEventListener('error', maybe_lost_connection, false);
	event_source.addEventListener('heartbeat', reset_watchdog, false);
	event_source.addEventListener('avr_update', parse_avr_state, false);
	set_connecting(true);
}

window.onload = connect_event_source;

	</script>
</head>
<body>

<div data-role="page" id="controls_page" style="text-align: center">

<div data-role="header">
	<h1>A/V remote control</h1>
</div>

{% if "avr on" in cmd_handlers %}
<div data-role="content" id="avr_controls" class="ui-disabled">
	<h2>Surround Receiver</h2>

	<span id="avr_button_on">
		<button onclick="send_cmd('avr on')"
			data-inline="true"
			data-theme="a">On</button>
	</span>
	<span id="avr_button_off">
		<button onclick="send_cmd('avr off')"
			data-inline="true"
			data-theme="a">Off</button>
	</span>
	<span id="avr_surroundcontrols">
		<span data-role="controlgroup" data-type="horizontal">
			<!-- <button onclick="send_cmd('avr surround 6ch')">
				5.1
			</button> -->
			<button onclick="send_cmd('avr surround dolby')">
				<!-- Dolby -->Surround
			</button>
			<!-- <button onclick="send_cmd('avr surround dts')">
				DTS
			</button> -->
			<button onclick="send_cmd('avr surround stereo')">
				Stereo
			</button>
		</span>
	</span>

	<div id="avr_volumecontrols" data-role="controlgroup" data-type="horizontal">
		<button onclick="repeat_cmd('avr vol-', 5)"><b>-5</b></button>
		<button onclick="send_cmd('avr vol-')"><b>-1</b></button>
		<span id="avr_volume">
			<button onclick="send_cmd('avr mute')" data-theme="b">
				Mute
			</button>
		</span>
		<button onclick="send_cmd('avr vol+')"><b>+1</b></button>
		<button onclick="repeat_cmd('avr vol+', 5)"><b>+5</b></button>
	</div>

	<div id="avr_state"><p>Initializing...</p></div>
</div>
{% end %}

{% if "hdmi on" in cmd_handlers %}
<div data-role="content" id="hdmi_controls" class="ui-disabled">
	<h2>HDMI Switch</h2>

	<div data-role="controlgroup" data-type="horizontal">
		<button onclick="send_cmd('hdmi on')" data-theme="a">On/Off</button>
		<button onclick="send_cmd('hdmi 1')">HTPC</button>
		<button onclick="send_cmd('hdmi 2')">Get</button>
		<button onclick="send_cmd('hdmi 3')">PS3</button>
		<button onclick="send_cmd('hdmi 4')">Wii</button>
	</div>

	<pre id="hdmi_state">???</pre>
</div>
{% end %}

<div data-role="footer">
	<p>by Johan Herland
	&lt;<a href="mailto:johan@herland.net">johan@herland.net</a>&gt;</p>
</div>

</div>

</body>
</html>
