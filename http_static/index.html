<!DOCTYPE html>
<meta charset="utf-8" />
<title>A/V remote control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/static/jquery.mobile-1.1.0.min.css" />
<style type="text/css">

h2 { margin-top: 0; }
div#controls_page { text-align: center; }
pre#audio_state { font-size: small; }
.ui-block-a { width: 30%; }
.ui-block-b { width: 40%; }
.ui-block-c { width: 30%; }
.ui-block-a .ui-corner-left, .ui-block-a .ui-corner-right { width: 49%; }
.ui-block-a .ui-corner-left .ui-btn-inner,
.ui-block-a .ui-corner-right .ui-btn-inner {
    width: 100%;
    padding-left: 0;
    padding-right: 0;
    text-align: center;
}
.ui-content { padding: 10px 2px 0 2px; }
.large { font-size: larger; }
.small { font-size: smaller; }

</style>
<script src="/static/jquery-1.7.2.min.js"></script>
<script src="/static/jquery.mobile-1.1.0.min.js"></script>
<script>

var socket = null;

function send_cmd(cmd) {
    console.log("sending", cmd);
    socket.send(cmd)
}

function repeat_cmd(cmd, repeats) {
    var i = 0
    while (i < repeats) {
        send_cmd(cmd);
        i++;
    }
}

function ui_enable(selector, enable) {
    if (enable) {
        $(selector).removeClass('ui-disabled');
    }
    else {
        $(selector).addClass('ui-disabled');
    }
}

function parse_audio_state(event) {
    var state = JSON.parse(event.data); // extract AVR state info

    if (!state) {
        return $('#audio_state').text("Unknown");
    }

    ui_enable('#audio_controls', !state.off);
    if (state.off) {
        return $('#audio_state').text("Off");
    }

    ui_enable('#audio_sourcecontrols', !state.standby);
    ui_enable('#audio_surroundcontrols', !state.standby);
    ui_enable('#audio_digitalcontrols', !state.standby);
    ui_enable('#audio_volumecontrols', !state.standby);
    // TODO: Standby button color: yellow in standby, blue when on.
    if (state.standby) {
        return $('#audio_state').text("Standby");
    }

    $('#audio_state').text(
        state.volume + "dB\n\n" +
        $.trim(state.line1) + "\n" +
        $.trim(state.line2) + "\n\n" +
        state.source + "\n" +
        state.channels_string + " -> " + state.speakers_string_short + "\n" +
        state.surround_string);

    if (state.volume != null) {
        var vol = state.volume + "dB\n";
        $('#audio_volume').text(vol);
    }
    if (state.mute) {
        $('#audio_volume').text("Muted");
    }
}

function connect_socket() {
    socket = new WebSocket("ws://" + window.location.host + "/ws");
    socket.onopen = function(event) {
        console.log("open");
        $('#connect_status').text("âœ”");
    };
    socket.onmessage = function(event) {
        console.log("message:", event);
        parse_audio_state(event)
    };
    socket.onerror = function(event) {
        console.log("error:", event);
        $('#connect_status').text("ðŸ™»");
    };
    socket.onclose = function(event) {
        console.log("closed, reconnecting in 5s...");
        $('#connect_status').text("âœ˜");
        setTimeout(connect_socket, 5000);
    };
}

window.onload = connect_socket;

</script>

<div data-role="page" id="controls_page">

<div data-role="header">
    <h1>A/V remote control <span id="connect_status">â‹¯</span></h1>
</div>

<div data-role="content" id="audio_controls">
    <h2>Surround Receiver</h2>

    <div class="ui-grid-b">
        <div class="ui-block-a">
<!--            <a id="audio_standby_button" onclick="send_cmd('audio on_off')"
            data-role="button" data-theme="a">
                <span class="large">&#9211;</span>
            </a> -->
            <span id="audio_powercontrols" data-role="controlgroup" data-type="horizontal">
                <a onclick="send_cmd('audio on')" data-role="button" data-theme="a">
                    Power On <!-- <span class="large">&#x23FD;</span> -->
                </a>
                <a onclick="send_cmd('audio off')" data-role="button" data-theme="a">
                    Power Off <!-- <span class="large">&#x2B58;</span> -->
                </a>
            </span>
            <span id="audio_sourcecontrols" data-role="controlgroup" data-type="horizontal">
                <a onclick="send_cmd('audio source vid1')" data-role="button">
                    Source: HTPC <!-- VID1/HTPC -->
                </a>
                <a onclick="send_cmd('audio source vid2')" data-role="button">
                    Source: TV <!-- VID2/TV -->
                </a>
            </span>
            <span id="audio_surroundcontrols" data-role="controlgroup" data-type="horizontal">
                <!-- <a onclick="send_cmd('audio surround 6ch')" data-role="button">
                    5.1
                </a> -->
                <a onclick="send_cmd('audio surround dolby')" data-role="button">
                    Dolby 5.1 <!-- &#127902; - 5.1 -->
                </a>
                <!-- <a onclick="send_cmd('audio surround dts')" data-role="button">
                    DTS
                </a> -->
                <a onclick="send_cmd('audio surround stereo')" data-role="button">
                    Stereo 2.0 <!-- &#128254; - 2.0 -->
                </a>
            </span>
            <span id="audio_digitalcontrols" data-role="controlgroup" data-type="horizontal">
                <a onclick="send_cmd('audio dig-')" data-role="button">
                    Digital &#9204;
                </a>
                <a onclick="send_cmd('audio dig+')" data-role="button">
                    Digital &#9205;
                </a>
            </span>
        </div>
        <div class="ui-block-b">
            <pre id="audio_state">Initializing...</pre>
        </div>
        <div class="ui-block-c">
            <div id="audio_volumecontrols" data-role="controlgroup">
                <a onclick="repeat_cmd('audio vol+', 5)" data-role="button">
                    <span class="large">&#128266;</span> +5dB
                </a>
                <a onclick="send_cmd('audio vol+')" data-role="button">
                    <span class="small">&#128266;</span> +1dB
                </a>
                <a onclick="send_cmd('audio mute')" data-theme="b" data-role="button">
                    <small>&#128263;</small>
                    <span id="audio_volume">â‹¯</span>
                </a>
                <a onclick="send_cmd('audio vol-')" data-role="button">
                    <span class="small">&#128265;</span> -1dB
                </a>
                <a onclick="repeat_cmd('audio vol-', 5)" data-role="button">
                    <span class="large">&#128265;</span> -5dB
                </a>
            </div>
        </div>
    </div>

</div>

<div data-role="content" id="hdmi_controls">
    <h2>HDMI Switch</h2>

    <a onclick="send_cmd('hdmi on')" data-inline="true" data-theme="a" data-role="button">
        <span class="large">&#9211;</span>
    </a>
    <span data-role="controlgroup" data-type="horizontal">
        <a onclick="send_cmd('hdmi 1')" data-role="button">HTPC</a>
        <a onclick="send_cmd('hdmi 2')" data-role="button">Get</a>
        <a onclick="send_cmd('hdmi 3')" data-role="button">PS3</a>
        <a onclick="send_cmd('hdmi 4')" data-role="button">Wii</a>
    </span>
</div>

<div data-role="footer">
    <p>by Johan Herland
    &lt;<a href="mailto:johan@herland.net">johan@herland.net</a>&gt;</p>
</div>

</div>
